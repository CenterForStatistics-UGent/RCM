---
title: "Kostic data: High dimensional methods"
author: "Stijn"
date: "March 24, 2016"
output: pdf_document
---
```{r settings, echo=FALSE}
knitr::opts_chunk$set(cache = TRUE, autodep = TRUE, eval=TRUE, warning=FALSE, include =TRUE, echo=FALSE)
```

We investigate some of the High Dimensional methods on the Kostic dataset, which contains healthy individuals as well as two groups of diseased (T1D and seroconverters). According to the paper, age at collection is the strongest driver of community composition

```{r LoadInData}
setwd("/home/stijn/PhD/Biplots/Kostic data")
load("/home/stijn/PhD/Biplots/Kostic data/KosticData.RData")
library(phyloseq)

#Construct tax_table object
taxData = Kostic$ConsensusLineage
taxDataFull= t(sapply(as.character(taxData), function(x){
  tmp = strsplit(x,";" , fixed=TRUE)[[1]]
 gsub("  ","",gsub("[[:alpha:]]__","",tmp))
  }))
colnames(taxDataFull) = c("Kingdom","Phylum","Class","Order","Family","Genus","Species")
rownames(taxDataFull) = Kostic$Number
taxDataObj = tax_table(taxDataFull)

#otu_table
otuTabTmp = Kostic[,-c(1, ncol(Kostic))]
rownames(otuTabTmp) = Kostic$Number
otuTab = otu_table(otuTabTmp, taxa_are_rows=TRUE)

#Sample data
samDatTmp = read.table("SamData.txt", header=TRUE, sep="\t")
rownames(samDatTmp) = samDatTmp$G_id
samDat = sample_data(samDatTmp)

#Build the phyloseq object
phyloD = phyloseq(samDat, otuTab, taxDataObj)

#Trim by prevalence
minPrev = .01
taxaKeep = rowMeans(otu_table(phyloD)@.Data == 0) >= minPrev
phyloD = prune_taxa(phyloD, taxa=taxaKeep)

#Trim by library size
minLib = 1e2
samplesKeep =sample_sums(phyloD) >= minLib
phyloD = prune_samples(samplesKeep, phyloD)

#Force orientation nxp
if(taxa_are_rows(phyloD)){
  phyloD=t(phyloD)
}

save(phyloD, file="phyloD.RData")
```

#Exploratory analysis

##Correspondence analysis

```{r ExploratoryStats}
setwd("/home/stijn/PhD/Biplots/Kostic data")
load(file="phyloD.RData")
#names(sample_data(phyloD))
#lapply(sample_data(phyloD), summary)
#Remove irrelevant variables
#irrelVar = c("G_id","Total_Reads","Read_Depth_Class","DNA_Concentration","DNA_Yield_Class")
#sample_data(phyloD) = sample_data(phyloD)[,!names(sample_data(phyloD)) %in% irrelVar]
ordCCA = ordinate(phyloD, method="CCA")
plot_ordination(phyloD, ordCCA, type="split", shape="Delivery_Route", color="Age_at_Collection", label="G_id")
#Which sample is so outlying?
plot(ordCCA$CA$u[,1],ordCCA$CA$u[,2], type="n")
text(ordCCA$CA$u[,1],ordCCA$CA$u[,2],labels=rownames(ordCCA$CA$u))
weirdSam = sample_names(phyloD)[which(ordCCA$CA$u[,1]>40)]
#summary(otu_table(phyloD)@.Data[ weirdSam,])
#hist(otu_table(phyloD)@.Data[ weirdSam,])
#table(otu_table(phyloD)@.Data[ weirdSam,])
#Nothing special
#sample_data(phyloD)[weirdSam,]
#Neihter in the covariates
#Look at the loading of the first principal inertia
options(digits=2)
#head(sort(ordCCA$CA$v[,1], decreasing=TRUE))
#Three taxa have very high loadings. Lets have a look at their abundance distributions
outTaxa = names(sort(ordCCA$CA$v[,1], decreasing=TRUE)[1:3])
#summary(otu_table(phyloD)@.Data[,outTaxa])
#Calculate relative abundances
countMat = otu_table(phyloD)@.Data
relMat = t(t(countMat)/sample_sums(phyloD))
#quantile(colMeans(relMat)) #OVeral distribution of realtive abundances
colMeans(relMat)[outTaxa] #Average abundance of the outlying species
relMat[weirdSam, outTaxa] #Abundances in the outliers
#countMat[weirdSam, outTaxa]
#quantile(countMat)
#Very high unexpected fractions indeed!
#Leave out this sample, it may be an outlier?
phyloDD = prune_samples(phyloD, samples = !sample_names(phyloD) %in% weirdSam)
ordCCAdd = ordinate(phyloDD, method="CCA")
plot_ordination(phyloDD, ordCCAdd, type="biplot", label="G_id", title="CA without outlier")
#plot_scree(ordCCAdd)
save(phyloDD, file="phyloDD.RData")
```

Removing the outlier does recover the expected plot. We see that the Chi-squared distance is very sensitive to outliers. We might want to try other distance measures to get a more robust methods (e.g. Read and Crestie, 1984)

The current methodology hwover suffers from the typical "horseshoe shape". We try the detrended correspondence analysis by Hill and Guach, 1980

###DCA

```{r DCA}
ordDCAdd = ordinate(phyloDD, method="DCA")
plot_ordination(phyloDD, ordDCAdd, type="biplot", title="DCA without outlier")
#plot_scree(ordDCAdd) #Only 4 directions remain
```

DCA indeed solves the problem with the horseshoe, but is still sensitive to outliers. Maybe we can find an alternative to the `chi-distance` that is not as sensitive to outliers?

Potential  outliers  may  be  detected  by  seeking  rows  or  columns  thathave both

- high absolute co-ordinate  values
and
- high  contributions.

So far away from the barycenter and high masses.


##PCoA/MDS

```{r PCoA}
ordPCoA = ordinate(phyloD, method="PCoA", distance="bray")
plot_ordination(phyloD, ordPCoA, type="biplot", color="Age_at_Collection", title="PCoA with Bray Curtis distance with outlier")
#PCoA does not suffer from the outlier
#Plot age vs the first principal coordinate
#plot(sample_data(phyloD)$Age_at_Collection, ordPCoA$vectors[,1])
#Clear correlation
```

##NMDS

```{r NMDS, message=FALSE}
ordNMDS = suppressMessages(ordinate(phyloD, method="NMDS", distance="bray"))
plot_ordination(phyloD, ordNMDS, type="biplot", color="Age_at_Collection", title="NMDS with Bray-Curtis, with outlier")
#NMDS does not suffer from the outliers either
```

##PCA

```{r PCA}
ordPCA = ordinate(phyloD, method="RDA")
plot_ordination(phyloD, ordPCA, type="biplot", color="Age_at_Collection", title="PCA with outlier")
#Neither PCA is sensitive to outliers
#ordPCAdd = ordinate(phyloDD, method="RDA")
#plot_ordination(phyloDD, ordPCAdd, type="split", color="Age_at_Collection")
```

All these plots give very different results

```{r CA with ordianteObject, include=FALSE}
#str(ordCCAdd)
CA = ordCCAdd$CA
V=CA$v
U=CA$u
eigenVals = CA$eig
mat = otu_table(phyloDD)@.Data
#plot the samples
par(mfrow=c(1,1))
plot(U[,1], U[,2])
#Add the unit profiles (==species in standard coordinates)
unitProfiles = V[,1:2]
arrows(0,0,unitProfiles[,1], unitProfiles[,2],  col="blue")

#Repeat but now only use the standard coordinates for the samples
plot(U[,1]/sqrt(eigenVals[1]), U[,2]/sqrt(eigenVals[2]))
#Contribution coordinates
ContrProfiles = V[,1:2]*sqrt(ordCCAdd$colsum)*10 #Multiply by a factor for optimal visualization, does not change the interpretation
arrows(0,0,ContrProfiles[,1], ContrProfiles[,2],  col="blue")

#Only with the 20 most contributing species
plot(U[,1], U[,2])
#Contribution coordinates
ContrProfiles = V[,1:2]*sqrt(ordCCAdd$colsum)*10 #Multiply by a factor for optimal visualization, does not change the interpretation
vecLengths = rowSums(ContrProfiles^2)
Contr20Profiles = ContrProfiles[vecLengths>=sort(vecLengths, decreasing=TRUE)[20], ]
arrows(0,0,Contr20Profiles[,1], Contr20Profiles[,2],  col="blue")

#plot the species
plot(V[,1], V[,2])
```

Combining both is only a regular biplot if the square roots of the eigenvalues are similar in magnitude. The biplot in the plot_ordinate() function uses the unit profiles for the samples and is thus not a symmetric plot.

Detect outlier in untrimmed dataset through contribution coordinates

```{r detectOutlierThroughContribution}
plot(ordCCA$CA$v[,1]*sqrt(ordCCA$colsum), ordCCA$CA$v[,2]*sqrt(ordCCA$colsum), type="n", main="Contribution plot of species")
arrows(0,0,ordCCA$CA$v[,1]*sqrt(ordCCA$colsum), ordCCA$CA$v[,2]*sqrt(ordCCA$colsum))
#Clearly an outlier
```

The outlier can be removed and then added again as a supplementary point. A supplementary point does not contribute to the ordination, but is just shown according to its coordinates. If it remains outlying it's probably a real outlier. Let's try this out.

###Supplementary point

```{r OutlierSupplPoint}
supplPoint = c(ordCCA$CA$u[weirdSam,1], ordCCA$CA$u[weirdSam,2])
plot(U[,1], U[,2], xlim=range(U[,1], supplPoint[1]), ylim=range(U[,2], supplPoint[2]), main="Supplementary point for outlier")
points(supplPoint[1],supplPoint[2], col="blue",pch=20)
```

A real outlier indeed

##Alternative distances

We try out some alternative distances and see what the effect is with respect to the outlier

###Chi squared

```{r altDistancesChiSq}
plot_ordination(phyloD, ordCCA, type="biplot", title="CA with outlier")
```

###Hellinger (Freeman-Tukey)

```{r altDistancesHellinger}
library(vegan)
helDist = vegdist(decostand(otu_table(phyloD)@.Data, "hell"), "euclidean") #sqrt(R)(X-E)
helOrd=ordinate(phyloD, distance=helDist, method="PCoA")
plot_ordination(phyloD, helOrd, type="biplot", title="Hellinger distance with outlier")
```

We see that the hellinger distance is less sensitive to the outlier. We try the same plots but now without the one outlying observation

```{r altDistances without outlier}
plot_ordination(phyloDD, ordCCAdd, type="biplot", title="CA without outlier")
helDistDD = vegdist(decostand(otu_table(phyloDD)@.Data, "hell"), "euclidean")
helOrdDD=ordinate(phyloDD, distance=helDistDD, method="PCoA")
plot_ordination(phyloDD, helOrdDD, type="biplot", title="Hellinger distance without outlier")
```

In regular CA, the samples are weighted according to their sum. Do we really want this? On the one hand, larger library sizes give more certainty, but thet don't really reflect presence of more bacteria. 

Some other distances from
Cressie and Read, 1984

- Freeman-Tukey == Hellinger distance
- log likelihood, modified loglikelihood and modified Neyman rely on logs or dividing by count sand can thus never be used with 

As opposed to the chi-squared, the hellinger distance does not weigh by taxon abundance and does not place more weight on less abundant taxa. But in reality, a 1\% difference in abundance means more for small taxa than for large ones. Neither of both techniques is strictly subcompositionally coherent.

for $c_{ij}$ the count for sample i and taxon j the Chi-squared distance between samples k and l with m taxa is

$$\Big( \sum_{j=1}^m \frac{
\big(\frac{c_{kj}}{c_{k.}}-\frac{c_{lj}}{c_{l.}}\big)^2
}
{
c_j
} \Big)^{1/2}$$

and the hellinger distance is 

$$\Big( \sum_{j=1}^m \Big(\sqrt{\frac{c_{kj}}{c_{k.}}}-\sqrt{\frac{c_{lj}}{c_{l.}}}\Big)^2 \Big)^{1/2}$$

```{r CressieAndRead}
physeq =phyloD
mat =otu_table(physeq)@.Data
X = mat
R = diag(rowSums(mat))
C = diag(colSums(mat))
```

# Explaining the variation using covariates

##CCA: direct gradiant analysis

Now we have represented the distances between the samples as good as possible. Now we want to explain the distance as good as we can using the known covariates. This may not always represent the true population structure well, since there may be unmeasured variables that drive the composition.

We first try canonical correspondence analysis with all covariates

```{r CCA}
ordCCAvar = ordinate(formula=.~.-G_id, method="CCA", physeq=phyloD) #Remove sample identifier as covariate
plot_ordination(phyloD,ordCCAvar, type="biplot")
#ordCCAvar$CCA$alias
#ordCCAvar$CCA$biplot
#Plot the contribution of the variables
library(vegan)
plot(ordCCAvar$CCA$biplot[,1],ordCCAvar$CCA$biplot[,2], xlab="CCA1",ylab="CCA2")
sapply(1:nrow(ordCCAvar$CCA$biplot),function(i){
  x=ordCCAvar$CCA$biplot[i,1:2]
  if(sum(x^2)>0.1){
    text(x[1], x[2], labels=rownames(ordCCAvar$CCA$biplot)[i],cex=0.75)
  }
})
#Look at subject_IDT013815 on top
idOut= which(sample_data(phyloD)$Subject_ID=="T013815")
any(sample_names(phyloD)[idOut]==weirdSam)
#Not because of the outlier
idOut2= which(sample_data(phyloD)$Subject_ID=="E013487")
any(sample_names(phyloD)[idOut2]==weirdSam)
names(sample_data(phyloD))
#GADA is an IgG related to pancreas and diabetes
```

Looks like age at collection is strongly negatvely correlated with breast feeding and positively with type of food. This looks like a confounding effect.

Try again without the outlier

```{r CCAnoOutlier}
ordCCAvarDD = ordinate(formula=.~.-G_id, method="CCA", physeq=phyloDD) #Remove sample identifier as covariate
plot_ordination(phyloDD,ordCCAvarDD, type="biplot")
plot(ordCCAvarDD$CCA$biplot[,1],ordCCAvarDD$CCA$biplot[,2], xlab="CCA1",ylab="CCA2")
sapply(1:nrow(ordCCAvarDD$CCA$biplot),function(i){
  x=ordCCAvarDD$CCA$biplot[i,1:2]
  if(sum(x^2)>0.1){
    text(x[1]+rnorm(1,0,0.02), x[2]+rnorm(1,0,0.02), labels=rownames(ordCCAvarDD$CCA$biplot)[i],cex=0.75)
  }
})
names(sample_data(phyloD))
#GADA is an IgG related to pancreas and diabetes
```

No effect of the outlier, which indicate that it cannot be explained through the covariates and is probably a true outlier indeed.
Condition on age to see if the feeding pattern still plays a role then

```{r CCAnoOutlierCondAge}
ordCCAvarDDcond= ordinate(formula=.~.-G_id+ Condition(Age_at_Collection), method="CCA", physeq=phyloDD) #Remove sample identifier as covariate
plot_ordination(phyloDD,ordCCAvarDDcond, type="biplot")
plot(ordCCAvarDDcond$CCA$biplot[,1],ordCCAvarDDcond$CCA$biplot[,2], xlab="CCA1",ylab="CCA2")
foo = sapply(1:nrow(ordCCAvarDDcond$CCA$biplot),function(i){
  x=ordCCAvarDDcond$CCA$biplot[i,1:2]
  if(sum(x^2)>0.075){
    text(x[1]+rnorm(1,0,0.02), x[2]+rnorm(1,0,0.02), labels=rownames(ordCCAvarDDcond$CCA$biplot)[i],cex=0.75)
  }
})
```

After conditioning on age, the effect of the diet is reduced but still persists. Also subjects start to play a role.

Do CCA on the AG dataset to find role of BMI

```{r CCA AGphylo}
load("/home/stijn/PhD/American Gut/AGphylo.RData")
AGsub = prune_samples(!is.na(sample_data(AGphylo)$BMI), AGphylo)
agCCA = ordinate(method="CCA", physeq=AGsub, formula=as.formula(".~BMI"))
plot_ordination(AGsub, agCCA, type="biplot")
plot(agCCA$CCA$biplot[,1],agCCA$CCA$biplot[,2], xlab="CCA1",ylab="CCA2")
foo = sapply(1:nrow(agCCA$CCA$biplot),function(i){
  x=agCCA$CCA$biplot[i,1:2]
  if(sum(x^2)>0.075){
    text(x[1]+rnorm(1,0,0.02), x[2]+rnorm(1,0,0.02), labels=rownames(agCCA$CCA$biplot)[i],cex=0.75)
  }
})
#CA to lok for enterotypes
agCCAcomp = ordinate(method="CCA", physeq=AGphylo)
sample_data(AGphylo)$libSize=sample_sums(AGphylo)
plot_ordination(AGphylo, agCCAcomp, type="samples")
#DCA
agDCAcomp = ordinate(method="DCA", physeq=AGphylo)
plot_ordination(AGphylo, agDCAcomp, type="samples", color="SEQUENCING_METH")
#Colour by bacteroidites and prevotella

#Bray-Curtis
agBraycomp = ordinate(method="PCoA", physeq=AGphylo, distance="bray")
plot_ordination(AGphylo, agBraycomp, type="samples")

## CCA
agCCAcomp2 = ordinate(method="CCA", physeq=AGphylo,formula=as.formula(~.), na.action=na.omit)
plot_ordination(AGphylo, agCCAcomp2, type="biplot")
plot(agCCAcomp2$CCA$biplot[,1],agCCAcomp2$CCA$biplot[,2], xlab="CCA1",ylab="CCA2")
foo = sapply(1:nrow(agCCAcomp2$CCA$biplot),function(i){
  x=agCCAcomp2$CCA$biplot[i,1:2]
  if(sum(x^2)>0.075){
    text(x[1]+rnorm(1,0,0.02), x[2]+rnorm(1,0,0.02), labels=rownames(agCCAcomp2$CCA$biplot)[i],cex=0.75)
  }
})

#Use approximation of Nature publication of enterotypes
 library(doParallel)  # Do this and next line only if you have multi-cores
registerDoParallel(cores=3)
AGdistJob = mcparallel(phyloseq::distance(physeq=AGphylo,method="jsd", parallel=TRUE) )##TAKES 1.5h to run!
AGdist = mccollect(AGdistJob, wait=FALSE)[[1]]
save(AGdist, file="AGjsd.Rdata")
agJSD = ordinate(method="PCoA", physeq=AGphylo, distance =AGdist)
plot_ordination(AGphylo, agJSD, type="biplot") 
#Replace zeroes by pseudocounts
pseudoCount = 1e-6
AGcopy = AGphylo
tmpMat = otu_table(AGphylo)@.Data
tmpMat[tmpMat==0] = pseudoCount
otu_table(AGcopy)@.Data = tmpMat
AGdist2job = mcparallel(phyloseq::distance(AGcopy,"jsd", parallel=FALSE)) ##TAKES 1.5h to run!
AGdist2 = mccollect(AGdist2job, wait=FALSE)[[1]]
save(AGdist2, file="AGjsd1e-6.Rdata")
agJSD2 = ordinate(method="PCoA", physeq=AGcopy, distance =AGdist2)
plot_ordination(AGphylo, agJSD2, type="biplot") 
```

## Logratio analysis

We try logratio analysis with different pseudocounts

```{r LRA}
library(robCompositions)
mat = otu_table(phyloD)@.Data
pseudoCount = 1
matCopy = mat
matCopy[matCopy==0] =pseudoCount
cenPhy = cenLR(matCopy) 
KostCopy = phyloD
otu_table(KostCopy)@.Data = cenPhy$x.clr
LRAord = ordinate(method="RDA", physeq=KostCopy)
plot_ordination(KostCopy, LRAord, type="biplot", color="Age_at_Collection")

pseudoCount = 1e-2
matCopy = mat
matCopy[matCopy==0] =pseudoCount
cenPhy2 = cenLR(matCopy) 
KostCopy = phyloD
otu_table(KostCopy)@.Data = cenPhy2$x.clr
LRAord2 = ordinate(method="RDA", physeq=KostCopy)
plot_ordination(KostCopy, LRAord2, type="biplot", color="Age_at_Collection")

pseudoCount = 1e-4
matCopy = mat
matCopy[matCopy==0] =pseudoCount
cenPhy2 = cenLR(matCopy) 
KostCopy = phyloD
otu_table(KostCopy)@.Data = cenPhy2$x.clr
LRAord2 = ordinate(method="RDA", physeq=KostCopy)
plot_ordination(KostCopy, LRAord2, type="biplot", color="Age_at_Collection")

pseudoCount = 1e-6
matCopy = mat
matCopy[matCopy==0] =pseudoCount
cenPhy2 = cenLR(matCopy) 
KostCopy = phyloD
otu_table(KostCopy)@.Data = cenPhy2$x.clr
LRAord2 = ordinate(method="RDA", physeq=KostCopy)
plot_ordination(KostCopy, LRAord2, type="biplot", color="Age_at_Collection")

pseudoCount = 1e-12
matCopy = mat
matCopy[matCopy==0] =pseudoCount
cenPhy2 = cenLR(matCopy) 
KostCopy = phyloD
otu_table(KostCopy)@.Data = cenPhy2$x.clr
LRAord2 = ordinate(method="RDA", physeq=KostCopy)
plot_ordination(KostCopy, LRAord2, type="biplot", color="Age_at_Collection")
```

The pseudocounts have quite an impact on the result
