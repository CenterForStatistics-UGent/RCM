---
title: "A manual for the use of the RCM functions"
author: "Stijn Hawinkel"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r check-install-load-packages, warning=FALSE, message=FALSE, echo=FALSE, purl=TRUE}
knitr::opts_chunk$set(cache = TRUE, autodep = TRUE,  warning=FALSE, message=FALSE, echo=TRUE, eval=TRUE, tidy = TRUE, fig.width=9, fig.height=6, purl=TRUE, fig.show = "hold", cache.lazy = FALSE)
# The required package list:
reqpkg <- c("phyloseq","MASS", "parallel","nleqslv", "edgeR", "ggplot2", "alabama", "reshape2", "tensor", "locfit", "flux", "vegan")
# Load all required packages and show version
for(i in reqpkg)
{
  print(i)
  print(packageVersion(i))
  library(i, quietly=TRUE, verbose=FALSE, warn.conflicts=FALSE, character.only=TRUE)
} 
palStore = palette()
funFiles = dir("R")
for (i in funFiles) {source(file.path("R",i))} # Run all fitting functions
```

## Dataset

As example data we use a study on the microbiome of colorectal cancer patients "Potential of fecal microbiota for early-stage detection of colorectal cancer" (2014) by Zeller _et al._.

```{r downLoad Data}
#Download the necessary files
dir.create("data")
download.file("http://users.ugent.be/~shawinke/data/species.txt", destfile = "./data/species.txt")
download.file("http://users.ugent.be/~shawinke/data/cancer_metadata.txt", destfile = "./data/cancer_metadata.txt")
zellerMeta = read.table("./data/cancer_metadata.txt", header=TRUE, sep="") #Read in the patient metadata
zellerS = read.table("./data/species.txt", header=TRUE, sep="\t", row.names=1) #The 16S count data
```

Although our package does accept count matrices, we recommend merging all the data into a _phyloseq_ object fro RCM fitting.

```{r formatData}
Sotu = otu_table(round(zellerS[-1,]), taxa_are_rows=TRUE) #Round to integers
Smeta = sample_data(zellerMeta)
rownames(Smeta) = gsub("-",".",Smeta$Sample)
zellerSphy = phyloseq(Smeta, Sotu) #Create the phyloseq object
```

## Unconstrained RCM

The unconstrained RC(M) method represents all variability present in the data, regardless of covariate information. It should be used as a first step in an exploratory analysis. We fit a model with two dimensions, which takes a few minutes.

```{r fitUnconstrainedRCM}
ZellerRCM2 = RCM(zellerSphy, k=2)
```

The runtime was `r round(ZellerRCM2$runtime,1)` minutes to be exact. We plot the result of this ordination in a biplot, beginning with the samples.

```{r plotUnconstrainedRCMsam}
plot(ZellerRCM2, plotType = "samples")
```

No clear signal is present at first sight. Note also that the plot is rectangular according to the values of the importance parameters $\psi$. In order to truthfully represent the distances between samples all axis must be on the same scale. We can add a colour code for the cancer diagnosis contained in the phyloseq object.

```{r plotUnconstrainedRCMsamCol}
plot(ZellerRCM2, plotType = "samples", samColour = "Diagnosis")
```

It is clear that some of the variability of the samples is explained by the cancer status of the patients.

Next we plot only the species.

```{r plotUnconstrainedRCMspec}
plot(ZellerRCM2, plotType = "species")
```

The researchers found that species from the Fusobacteria genus are associated with cancer. We can plot only these species using a regular expression.

```{r plotUnconstrainedRCMspec2}
plot(ZellerRCM2, plotType = "species", taxRegExp = "Fusobacter", taxLabels = TRUE)
```

It is clear that these Fusobacterium species behave very differently between the species.

Finally we can combine both plots into an interpretable biplot, which is the default for unconstrained RC(M). To avoid overplotting we only show the taxa with the 10 most important departures from independence.

```{r plotUnconstrainedRCMall}
plot(ZellerRCM2, taxNum = 10, samColour = "Diagnosis")
```

Samples are represented by dots, taxa by arrows. Both represent vectors with the origin as starting point.

Valid interpretatations are the following:

 - Samples (endpoints of sample vectors, the red dots) close together depart from independence in a similar way
 - The orthogonal projection of the taxon arrows on the sample arrows are proportional to the departure from independence of that taxon in that sample on the log scale, in the first two dimensions. For example Fusobacterium mortiferum is more abundant than average in samples on the left side of the plot, and more abundant in samples on the right side.
 - The importance parameters $\psi$ shown for every axis reflect the relative importance of the dimensions
 
Distances between endpoints of taxon vectors are meaningless.

### Adding dimensions

Since the model is fitted dimension per dimension, we only have information on the first two dimension. If we want to add a third dimension, we do not have to start from scratch but can use the previously fitted model in two dimension as a starting point and additionally estimate the third dimension.

```{r addDimension}
ZellerRCM3 = RCM(zellerSphy, prevFit = ZellerRCM2, k = 3)
```

The total runtime for all dimensions combined was `r round(ZellerRCM3$runtime,1)`. We can then plot any combination of two dimensions we want, e.g. the first and the third.

```{r plotAddedDimension}
plot(ZellerRCM3, Dim = c(1,3), samColour = "Diagnosis", taxNum = 6)
```

The third dimension also correlates with a separation of cancer patients vs. healthy and small adenoma patients.

## Constrained analysis

In this second step we look for the variability in the dataset explained by linear combinations of covariates that maximally separate the niches of the species. This should be done in a second step, and preferably only with variables that are believed to have an impact on the species' abundances. Here we used the variables age, gender, BMI, country and diagnosis in the gradient.
In this analysis all covariates values of a sample are projected onto a single scalar, the environmental score of this sample. The projection vector is called the environmental gradient, the magnitude of its components reveals the importance of each variable. The taxon-wise response functions then describe how the logged mean abundance depends on the environmental score.

### Linear response functions

Even though these response functions may be too simplistic, they have the advantage of being easy to interpret (and plot).

```{r constrLin}
ZellerRCM2constr = RCM(zellerSphy, k = 2, covariates = c("Age","Gender","BMI","Country", "Diagnosis"), responseFun = "linear")
```

First we plot the samples

```{r constrLinPlot}
plot(ZellerRCM2constr, plotType = c("samples"))
```

In the constrained analysis we clearly see three groups of samples appearing.

```{r constrLinPlot2}
plot(ZellerRCM2constr, plotType = c("samples"), samColour = "Diagnosis")
```

One group are the healthy patients, the other two are cancer patients.

```{r constrLinPlot3}
plot(ZellerRCM2constr, plotType = c("samples"), samColour = "Country")
```

The cancer patients are separated by country. Note that from Germany there are only cancer patients in this dataset.

Now we add the species to make a biplot

```{r plotlin2cor}
plot(ZellerRCM2constr, plotType = c("species", "samples"))
```

The interpretation is similar as before: the orthogonal projection of a taxon's arrow on a sample represents the departure from independence for that taxon in that sample, _explained by environmental variables_. New is also that the taxa arrows do not strt from the origin, but all have their own starting point. This starting point represents the environmental scores for which there is no departure from independence. The direction of the arrow then represents how its expected abundance increases.

Next we can make a biplot of taxa and environmental variabless.

```{r plotlin3}
plot(ZellerRCM2constr, plotType = c("species", "variables"))
```

The projection of species arrows on environmental variables (starting from the origin) represents the sensitivity of this taxon to changes in this variables. Note that the fact that the arrows of BMI and gender are of similar lenght indicates that one _standard deviation_ in BMI has a similar effect to gender.

We observe that country and diagnosis are the main drivers of the environmental gradient. We also see that healthy patients are very similar to small adenoma patients, but that they are very different from cancer patients.

To finish we also show the triplot, which unites all the information of the ordination:

```{r plotlin3Triplot}
plot(ZellerRCM2constr)
```

Note that the samples and the environmental variables cannot be related to each other.

### Non-parametric response functions

These response functions are very data driven, but have the drawback that they do not allow to visualize the role of the taxa in the ordination.

```{r fitNonParam}
ZellerRCM2constrNonParam = RCM(zellerSphy, k = 2, covariates = c("Age","Gender","BMI","Country", "Diagnosis"), responseFun = "nonparametric")
```

```{r plotnonParam}
plot(ZellerRCM2constrNonParam, plotType = "samples")
```

Using non-parametric response functions we do not find the same clear clusters

```{r plotnonParamCol}
plot(ZellerRCM2constrNonParam, plotType = "samples", samColour = "Diagnosis")
```

Show the variables

```{r plotnonParamVar}
plot(ZellerRCM2constrNonParam, plotType = "variables")
```