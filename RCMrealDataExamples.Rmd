---
title: "RCMrealDataExamples"
author: "Stijn"
date: "November 9, 2017"
output: pdf_document
---

```{r setup, warning=FALSE, message=FALSE, echo=FALSE, purl=TRUE}
WD = "/home/stijn/PhD/Biplots"
knitr::opts_knit$set(root.dir = WD)
knitr::opts_chunk$set(cache = TRUE, autodep = TRUE,  warning = FALSE, message=FALSE, echo=FALSE, eval=TRUE, tidy = TRUE, fig.width = 9, fig.height=6, purl=TRUE, fig.show = "hold", cache.lazy = FALSE)
```

```{r check-install-load-packages, warning=FALSE, message=FALSE, echo=FALSE, purl=TRUE}
# The required package list:
reqpkg <- c("phyloseq", "ggplot2", "reshape2", "parallel")
# Load all required packages and show version
for(i in reqpkg)
{
#   print(i) 
#   print(packageVersion(i))
  library(i, quietly=TRUE, verbose=FALSE, warn.conflicts=FALSE, character.only=TRUE)
} 
par(pty="s", mar = c(8,2,4,2), cex.main = 0.9) #Make sure the biplots are square!
palStore = palette()
funFiles = dir("R")
funFilesPub = dir("pubFun")
for (i in funFiles) {source(file.path("R",i))}
for (i in funFilesPub) {source(file.path("pubFun",i))};rm(i)
load("/home/stijn/PhD/American Gut/AGphylo.RData")
load("/home/stijn/PhD/Simulations/data/physeqListV13.RData")
```

We apply the RC(M) method to a number of real datasets.

# HMP

The Human Microbiome Project (HMP) aimed to characterize the healthy human microbiome.

```{r RC(M)_NB real datasets, purl = FALSE}
realNames = c("AGP", "Hard.palate", "Buccal.mucosa", "Anterior.nares", "Left.Antecubital.fossa", "Posterior.fornix",  "Mid.vagina", "Left.Retroauricular.crease", "Vaginal.introitus", "Stool", "Hard.palate")
if(!file.exists(file = "resListRCMagphmp.RData")){
resListRCM = lapply(c(AGphylo, physeqListV13[realNames[-1]]),RCM, k = 3)
names(resListRCM) = realNames
save(resListRCM, file = "resListRCMagphmp.RData")
} else {load(file = "resListRCMagphmp.RData")}

SClevels  = unique(c(unlist(sapply(physeqListV13, function(x){
  levels(get_variable("RUNCENTER",physeq=x))
}))))
#Give similar colours for the same sequencing center
cols = c("cadetblue","cyan", "darkblue","blue","magenta","orange","yellow","brown","black",  "grey80","grey70","pink") 
palette(cols)
```

```{r HMPplot, purl = FALSE, include = FALSE, fig.cap="Biplot of the RC(M) ordination of the Anterior nares dataset of the HMP. Colours indicate sequencing center. Sequencing center clearly affects the obtained microbiome compositions. \\label{fig:samHMP}"}
plot(resListRCM[["Anterior.nares"]], samColour ="RUNCENTER", colLegend = "Sequencing center")
```

## Conditioning

Since we know that sequencing facility affects the outcome of the sequencing assay and one is not interested in visualizing this technical variability we can condition out this variable. We condition only on the primary sequencing center.

```{r HMP filter out variable effect, purl=FALSE, fig.cap="Biplot of the RC(M) ordination of the HMP Anterior nares dataset after conditioning. Colours indicate sequencing center. The effect of sequencing center has been largely filtered out. \\label{fig:samHMP}"}
if(!file.exists(file="/home/stijn/PhD/Biplots/filtResHMP.RData")){
  K=2
nleqslv.control = list()
#Group the runcenters together

RCMhmpFilt = lapply(physeqListV13, function(x){
  runcenters = data.frame(sample_data(x))[ "RUNCENTER"]
runcenters[["RUNCENTER"]][runcenters[["RUNCENTER"]] %in% c("BCM","BI,BCM","BCM,BI","BCM,WUGC", "BCM,JCVI")] = "BCM"
runcenters[["RUNCENTER"]][runcenters[["RUNCENTER"]] %in% c("JCVI","JCVI,BI","JCVI,WUGC")] = "JCVI"
runcenters[["RUNCENTER"]][runcenters[["RUNCENTER"]] %in% c("WUGC,JCVI","WUGC","WUGC,BCM")] = "WUGC"
sample_data(x) = data.frame(sample_data(x) ,RUNCENTER2 = runcenters[[1]])
x})
filtRes = lapply(RCMhmpFilt, function(x){
  RCM(x, distribution="NB", k = K, nleqslv.control= nleqslv.control, maxItOut=5e3, prevCutOff=0.01, colWeights="marginal", rowWeights = "uniform", marginEst = "MLE", round=TRUE, confounders = "RUNCENTER2")
  })
save(filtRes, file="/home/stijn/PhD/Biplots/filtResHMP.RData")
} else {load(file="/home/stijn/PhD/Biplots/filtResHMP.RData")}

plot(filtRes[["Anterior.nares"]], samColour ="RUNCENTER", colLegend = "Sequencing center")
```

\clearpage

# The American gut project

The American gru project consits of stool samples sampled by volunteers at home, together with their answers to a questionnaire. Since they are sampled at home the variability is expected to be large.

```{r AGPplots, purl = FALSE}
plot(resListRCM[["AGP"]], samColour = "IBD")
```

The AGP dataset is presumably too noisy to find much of a signal

\clearpage

# The Zeller data

The Zeller data are obtained from a study on colorectal cancer in cancer patients and healthy controls \cite{Zeller2014}. Patient covariates recorded were age, gender, BMI, cancer diagnosis(healthy, small adenoma or cancer) and country(France or Germany).

```{r load zeller RC(M) NB results, purl = FALSE, include = FALSE}
load("/home/stijn/PhD/Simulations/data/zellerData.RData")
zellers = c("zellerMeta","zeller16S")
if(!file.exists("zellerSphyRCM.RData")){
zellerSphyRCM = RCM(zellerSphy, k=3, round = TRUE)
save(zellerSphyRCM, file="zellerSphyRCM.RData")
} else {load("zellerSphyRCM.RData")}

if(!file.exists("zellerMphyRCM.RData")){
zellerMphyRCM = RCM(zellerMphy, k=3, round = TRUE, prevCutOff = 0.05, minFraction = 0.15) # Less than one minute! More trimming needed here
save(zellerMphyRCM, file="zellerMphyRCM.RData")
} else {load("zellerMphyRCM.RData")}

zellerRCM  =list(zellerMphyRCM, zellerSphyRCM)
names(zellerRCM) = zellers

# sapply(zellerRCM,function(x){x$converged}) # All converged
# sapply(zellerRCM,function(x){x$runtime})
# sapply(zellerRCM,function(x){x$iter})
```

```{r plotZellerSphyDiagnosis, purl = FALSE}
plot.RCM(zellerSphyRCM, samColour = "Diagnosis", samShape = "Country")
```

```{r plotZellerMphy, purl = FALSE }
plot.RCM(zellerMphyRCM, samColour = "Diagnosis")
```

For the 16S data we see signals for Country and Cancer diagnosis. For the metagenomics data we do not see a trend. Notice we are doing indirect gradient analysis again, but this is just to look for confirmation that the unconstrained analysis is detecting true groups.

\clearpage

## The Zeller data: Constrained RC(M)

In the constrained analysis we use all the available covariates to construct the environmental gradient.

```{r zellerConstrained, purl =FALSE}
if(!file.exists("zellerSphyRCMconstr.RData")){
zellerSphyRCMconstrLin = RCM(zellerSphy, k=2, round = TRUE, covariates = c("Age","Gender","BMI","Country", "Diagnosis"), responseFun = "linear") # Use smallest possible cndtol!
zellerSphyRCMconstrLinML = RCM(zellerSphy, k=2, round = TRUE, covariates = c("Age","Gender","BMI","Country", "Diagnosis"), responseFun = "linear", envGradEst = "ML")
zellerSphyRCMconstrQuad = RCM(zellerSphy, k=2, round = TRUE, covariates = c("Age","Gender","BMI","Country", "Diagnosis"), responseFun = "quadratic")
zellerSphyRCMconstrNonParam = RCM(zellerSphy, k=2, round = TRUE, covariates = c("Age","Gender","BMI","Country", "Diagnosis"), responseFun = "nonparametric")
zellerSphyRCMconstrNonParamML = RCM(zellerSphy, k=2, round = TRUE, covariates = c("Age","Gender","BMI","Country", "Diagnosis"), responseFun = "nonparametric", envGradEst = "ML")
save(zellerSphyRCMconstrLin, zellerSphyRCMconstrLinML, zellerSphyRCMconstrQuad, zellerSphyRCMconstrNonParam,file="zellerSphyRCMconstr.RData")
} else {load("zellerSphyRCMconstr.RData")}
```

```{r ZellerConstrainedBiplot, purl=FALSE, eval = FALSE, fig.cap="Triplot of constrained RC(M) analysis on zeller data with linear response functions. Cancer diagnosis and country appear to be the most important variables. \\label{fig:triZellerDiagnosis}"}
plot.RCM(zellerSphyRCMconstrLin, samColour = "Diagnosis", samShape = "Country")
```

```{r ZellerConstrainedBiplotNonParam, purl=FALSE, eval = FALSE, fig.cap="Triplot of constrained RC(M) analysis on Zeller data with non-parametric response functions. The environmental gradient is similar as to the linear case, nly age is more important according to this model. \\label{fig:triZellerDiagnosisNP}"}
plot.RCM(zellerSphyRCMconstrNonParam, samColour = "Diagnosis", samShape = "Country")
```

\clearpage

# Turnbaugh et al. (2009)

In this study the fecal microbiome of monozygotic and dizygotic twins was characterized \cite{Turnbaugh2009}. On of the aims was to find a link with obesity.

```{r turnTwins, eval = FALSE, purl = FALSE}
if(!file.exists("turntwinsRCm.RData")){
  load(file = "/home/stijn/PhD/Datasets/TurnbaughObeseTwins/TurnTwins.RData")
turntwinsRCm = RCM(TurnTwins, k=3)
save(turntwinsRCm, file = "turntwinsRCm.RData")
} else {load("turntwinsRCm.RData")}
plot.RCM(turntwinsRCm, samColour = "Status_p", colLegend = "Weight status")
rm(turntwinsRCm)
```

With such small datasets it is hard to draw conclusions.

\clearpage

# Turnbaugh et al. (2009b)

In this group, 15 gnotobiotic mice were inoculated with human feces, and for one group the diet was switched to a Western diet after one month \cite{Turnbaugh200b9}. Then a second generation of mice was inoculated with cecal samples from the previous groups, and here also diet was varied. The variables recorded were:

- Diet: current diet
- Generation_p: "Recipient1" if second generation, otherwise diet of cecal samples with which they were inoculated
- Time: age of mouse at sampling
- DGS: Diet and previous diet
- DTG: combines sampling diet, time, and previous generation (if any) 

```{r turnmice, purl = FALSE}
if(!file.exists("turnMiceRCM.RData")){
  load(file = "/home/stijn/PhD/Datasets/Humanized mouse/HumMicePhy.RData")
HumMiceRCM = RCM(HumMicePhy, k=3)
HumMiceRCMlin = RCM(HumMicePhy, k=3, covariates = c("Diet","Generation_p","Time"))
gommsHum = gommsPhy(HumMicePhy)
save(HumMiceRCM, gommsHum, file = "turnMiceRCM.RData")
} else {load("turnMiceRCM.RData")}
```

```{r humMicePlot, purl = FALSE}
plot.RCM(HumMiceRCM) # Two or three distinct groups
```

This dataset appears to have a very strong signal, we can distinguish three or four clusters.

```{r humMicePlotSecondLook, purl = FALSE}
plot.RCM(HumMiceRCM, samColour = "Diet", samShape = "Generation_p")
```

It is clear that current diet is the dominant variable in the first dimension.

```{r humMicePlotSecondLookTime, purl = FALSE}
plot.RCM(HumMiceRCM, samColour = "Time", samShape = "Generation_p")
```

Also the older group of generation 1 mice is different, it separates in the second dimension.

\clearpage

# Kostic colorectal cancer

This is a study on the microbiome of colorectal cancer in humans \cite{Kostic2012}. Nine tumor patients were matched with 9 healthy patients, samples were taken repeatedly. The researchers find a enrichment of Fusobacteria in the tumor and a depletion of Bacteroidetes and Firmicutes.

```{r load Kostic, purl=FALSE}
if(!file.exists("Kostic.RData")){
filepath = system.file("extdata", "study_1457_split_library_seqs_and_mapping.zip", package="phyloseq")
kostic = microbio_me_qiime(filepath)
save(kostic, file = "Kostic.RData")
} else {load("Kostic.RData")}
```

For the constrained analysis we use the variables

- NECROSIS_PERCENT
- AGE
- NORMAL_EQUIVALENT_PERCENT
- FIBROBLAST_AND_VESSEL_PERCENT
- TREATMENT
- CEA (Carcinoembryonic antigen)
- SEX
- COUNTRY
- CHEMOTHERAPY
- HISTOLOGIC_GRADE
- TUMOR_PERCENT
- RADIATION_THERAPY
- INFLAMMATION_PERCENT
- PC3 (a prostate cancer cell line)

For radiation therapy and chemotherapy, "None" and "No" were pooled. For Necrosis percent, normal equivalent percent, tumor percent, inflammation percent and CEA, "None" was set to 0, for age to the average age. Necrosis percent, age, normal equivalent, fibroblast and vessel percent, and cea were treated as continuous variables

```{r KosticRCM}, purl = FALSE}
kostVars = c("NECROSIS_PERCENT_CONT","AGE_CONT","NORMAL_EQUIVALENT_PERCENT_CONT", "FIBROBLAST_AND_VESSEL_PERCENT_CONT", "TREATMENT",  "CEA_CONT", "SEX", "COUNTRY", "CHEMOTHERAPY_POOLED",  "HISTOLOGIC_GRADE", "TUMOR_PERCENT_CONT", "RADIATION_THERAPY_POOLED", "INFLAMMATION_PERCENT_CONT", "PC3")
if(!file.exists("kosticRCM.RData")){
sample_data(kostic) = within(sample_data(kostic),{
  RADIATION_THERAPY_POOLED = RADIATION_THERAPY
  RADIATION_THERAPY_POOLED[RADIATION_THERAPY_POOLED=="None"] = "No"
  RADIATION_THERAPY_POOLED = droplevels(RADIATION_THERAPY_POOLED)
  
  CHEMOTHERAPY_POOLED = CHEMOTHERAPY
  CHEMOTHERAPY_POOLED[CHEMOTHERAPY_POOLED=="None"] = "No"
  CHEMOTHERAPY_POOLED = droplevels(CHEMOTHERAPY_POOLED) 
  
  NECROSIS_PERCENT_CONT = NECROSIS_PERCENT
  NECROSIS_PERCENT_CONT[NECROSIS_PERCENT_CONT=="None"] = 0
  NECROSIS_PERCENT_CONT = as.numeric(as.character(NECROSIS_PERCENT_CONT))
  
  TUMOR_PERCENT_CONT = TUMOR_PERCENT
  TUMOR_PERCENT_CONT[TUMOR_PERCENT_CONT=="None"] = 0
  TUMOR_PERCENT_CONT = as.numeric(as.character(TUMOR_PERCENT_CONT))
  
  NORMAL_EQUIVALENT_PERCENT_CONT = NORMAL_EQUIVALENT_PERCENT
  NORMAL_EQUIVALENT_PERCENT_CONT[NORMAL_EQUIVALENT_PERCENT_CONT=="None"] = 0
  NORMAL_EQUIVALENT_PERCENT_CONT = as.numeric(as.character(NORMAL_EQUIVALENT_PERCENT_CONT))
  
  CEA_CONT = factor(CEA, levels = c(0, levels(CEA)))
  CEA_CONT[CEA_CONT=="None"] = 0
  CEA_CONT = as.numeric(as.character(CEA_CONT))
  
  INFLAMMATION_PERCENT_CONT = factor(INFLAMMATION_PERCENT, levels = c(0, levels(INFLAMMATION_PERCENT)))
  INFLAMMATION_PERCENT_CONT[INFLAMMATION_PERCENT_CONT=="None"] = 0
  INFLAMMATION_PERCENT_CONT = as.numeric(as.character(INFLAMMATION_PERCENT_CONT))
  
  FIBROBLAST_AND_VESSEL_PERCENT_CONT = factor(FIBROBLAST_AND_VESSEL_PERCENT, levels = c(0, levels(FIBROBLAST_AND_VESSEL_PERCENT)))
  FIBROBLAST_AND_VESSEL_PERCENT_CONT[FIBROBLAST_AND_VESSEL_PERCENT_CONT=="None"] = 0
  FIBROBLAST_AND_VESSEL_PERCENT_CONT = as.numeric(as.character(FIBROBLAST_AND_VESSEL_PERCENT_CONT))
  
  AGE_CONT = as.character(AGE)
  AGE_CONT[AGE_CONT=="None"] = mean(as.numeric(AGE_CONT[AGE_CONT!="None"]))
  AGE_CONT = as.numeric(AGE_CONT)
})
kosticRCM = RCM(kostic, k = 3)
kosticRCMlin = RCM(kostic, k = 3, covariates = kostVars, responseFun = "linear")
kosticRCMnp = RCM(kostic, k = 3, covariates = kostVars, responseFun = "nonparametric")
save(kosticRCM, kosticRCMlin, file = "kosticRCM.RData")
} else {load("kosticRCM.RData")}
```

```{r KosticPlots}
plot(kosticRCM, samColour = "TREATMENT")
plot(kosticRCM, samColour = "COUNTRY")
plot(kosticRCM, samColour = "CHEMOTHERAPY_POOLED")
plot(kosticRCM, samColour = "RADIATION_THERAPY_POOLED")
```

Country, chemotherapy and radiotherapy seem to be related to microbiome composition

```{r KosticPlots Constrained}
plot(kosticRCMlin)
```

Four sample clusters are visible. Important drivers of variability are the cancer status, country, tumor percentage and radiation therapy

```{r KosticPlotsConstrainedCol}
plot(kosticRCMlin, samColour = "TREATMENT", samShape = "COUNTRY")
```

The first dimension is dominated by country, the second by treatment, so these are the two most important variables. This is a bit surprising since the treatment does not seem to play a role in the unconstrained ordination.

\clearpage

# CMET data

This is a longitudinal dataset on microbial growth in a water cooling system of a nuclear power plant \cite{Props2016}.

```{r readInCMET, purl = FALSE, eval = FALSE}
if(!file.exists(file = "CMETdata.RData")){
  library(openxlsx)
  samData = read.xlsx("/home/stijn/PhD/Datasets/CMET/Metadata.xlsx")
  rownames(samData) = samData$sample_title
  samData$Reactor.cycle = as.character(samData$Reactor.cycle)
  samData$cellDensity = samData$`Cell.density.(cells/mL)`
  samData$`Cell.density.(cells/mL)` = NULL
  otuTab = read.csv("/home/stijn/PhD/Datasets/CMET/OTU_table_raw.csv", sep = ";")
  rownames(otuTab) = otuTab$Sample_ID
  otuTab$Sample_ID = NULL
  #Select only samples present in samData
  otuTab = otuTab[as.character(samData$sample_title),]
  #Multiply relative abundances by cell counts in samData. Not a good approach!
  # otuTab = round(as.matrix(otuTab)/rowSums(as.matrix(otuTab))*samData$cellDensity)
  taxTab = read.csv("/home/stijn/PhD/Datasets/CMET/tax_table_raw.csv", sep = ";")
  rownames(taxTab) = taxTab$X
  taxTab$X = NULL
  samData = samData[rowSums(otuTab)>0,]
  taxTab = taxTab[ colSums(otuTab)>0,]
  otuTab = otuTab[rowSums(otuTab)>0, colSums(otuTab)>0] #Number of zeroes is not related to rounding
  CMETwater = phyloseq(otu_table(otuTab, taxa_are_rows = FALSE), sample_data(samData), tax_table(as.matrix(taxTab)))
  save(CMETwater, file = "CMETdata.RData")
}else {load(file = "CMETdata.RData")}
```

```{r analysCMET, purl = FALSE}
if(!file.exists(file = "CMETRCM.RData")){
  CMETRCM = RCM(CMETwater, k = 3, prevCutOff = 0.05)
  envVarsCMET = c("ph","temp","Conductivity","cellDensity", "Reactor.phase", "Reactor.cycle")
  CMETRCMlin = RCM(CMETwater, k = 3, responseFun = "linear", covariates = envVarsCMET, prevCutOff = 0.05)
  CMETRCMquad = RCM(CMETwater, k = 3, responseFun = "quadratic", covariates = envVarsCMET, prevCutOff = 0.05)
  CMETRCMnonParam= RCM(CMETwater, k = 3, responseFun = "nonparametric", covariates = envVarsCMET, prevCutOff = 0.05)
  #Condition on time variable
  CMETRCMcond = RCM(CMETwater, k = 3, prevCutOff = 0.05, confounders = "Timepoint")
  save(CMETRCM, CMETRCMlin, CMETRCMnonParam, CMETRCMcond, file = "CMETRCM.RData")
} else {load(file = "CMETRCM.RData")}
```

```{r plotCMET, purl = FALSE}
plot(CMETRCM, samColour = "Reactor.phase", samShape = "Reactor.cycle")
```

The first dimension mainly tracks the change of the cooling water throughout the different phases, the second dimension is related to the reactor cylce

```{r plotCMETlin, purl = FALSE}
plot(CMETRCMlin, samColour = "Reactor.phase", samShape = "Reactor.cycle")
```

The constrained analysis confirms phase and cycle as being the most important drivers. Also, the most important taxa are seen to react to the gradient dominated by reactor cycle.

```{r plotCMETnp, purl = FALSE}
plot(CMETRCMnonParam, samColour = "Reactor.phase", samShape = "Reactor.cycle")
```

The sample ordination is similar when non-parametric response functions are used, but the role of reactor phase is assessed differently.